name: Meetdy Frontend Dev Environment

on:
  push:
    branches:
      - master

env:
  APP_NAME: meetdy-frontend-dev
  ENVIRONMENT: Dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout frontend
        uses: actions/checkout@v4

      # ğŸ” Login to GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ§± Versioning
      - name: Set version
        run: echo "VERSION=dev-1-${{ github.run_number }}" >> $GITHUB_ENV

      # ğŸ—ï¸ Build image
      - name: Build image
        run: |
          IMAGE=ghcr.io/${{ github.repository }}
          docker build -t $IMAGE:${{ env.VERSION }} .

      # ğŸš€ Push image
      - name: Push image
        run: |
          IMAGE=ghcr.io/${{ github.repository }}
          docker push $IMAGE:${{ env.VERSION }}

      # ğŸ“¥ Checkout infra repo
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4
        with:
          repository: meetdy/infrastructure
          ref: main
          token: ${{ secrets.INFRA_REPO_PAT }}
          path: infra

      # âœï¸ Update deployment.yaml
      - name: Update image tag
        run: |
          sed -i \
            's|image: *"ghcr.io/meetdy/meetdy-frontend:[^"]*"|image: "ghcr.io/meetdy/meetdy-frontend:'"$VERSION"'"|' \
            infra/manifests/frontend/deployment.yaml

      # ğŸ“¤ Commit & push
      - name: Commit and push (if changed)
        run: |
          cd infra
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          if git diff --quiet manifests/frontend/deployment.yaml; then
            echo "No image change detected. Skipping commit."
            exit 0
          fi

          git add manifests/frontend/deployment.yaml
          git commit -m "chore(frontend): deploy $VERSION"
          git push
